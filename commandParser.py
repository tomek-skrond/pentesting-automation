from executeCommand import executeCommand
import subprocess

DEFAULT_PATH = "/home/kali/Desktop/automation_results/"
WORKFLOW_PATH = "/home/kali/Desktop/automation/workflows/"

def parse_nmap(flags,date):

    if "command" in flags:
        
        folder=f"{DEFAULT_PATH}{date}/nmap_results.xml".replace("\n","")
        output = executeCommand(flags['command']+ f" -oX " + folder)

        #make report
        executeCommand(f"xsltproc {folder}" + " > " + f"{DEFAULT_PATH}{date}/nmap_results.html".replace("\n",""))


        print(output)

        print("--------------------------------------------------------")
        print("WORKFLOW ENDED SUCCESSFULLY")
        print(f"WORKFLOW OUTPUT FILE SAVED (location: {folder})".replace(".xml",".html"))
        print("--------------------------------------------------------")

        #remove nmap xml
        executeCommand(f"rm {folder}")
        
        proceed_questionmark()
            

def parse_metasploit(config_name):
    date = executeCommand('date +"%Y%m%d_%H%M%S"')

    folder=f"{DEFAULT_PATH}{date}/msf_results.txt".replace("\n","")
    command = f"msfconsole -r {WORKFLOW_PATH}{config_name}" + f" > " + folder
    #output = executeCommand(f"msfconsole -r {flags['config']}" + f" > " + folder)
    subprocess.call(['x-terminal-emulator', '-e', command])
    
    print("--------------------------------------------------------")
    print("WORKFLOW ENDED SUCCESSFULLY")
    print(f"WORKFLOW OUTPUT FILE SAVED (location: {folder})".replace(".xml",".html"))
    print("--------------------------------------------------------")

    proceed_questionmark()


def parse_commands(cmd_dict):
    #flags = cmd_dict["tasks"].values()
    
    date = executeCommand('date +"%Y%m%d_%H%M%S"')
    executeCommand(f"mkdir -p {DEFAULT_PATH}{date}/")

    for t in cmd_dict["tasks"].keys():


        print("RUNNING TASK:",t)

        if "nmap" in t:
            nmap_tasks = cmd_dict["tasks"]["nmap"]
            parse_nmap(nmap_tasks,date)

        if "metasploit" in t :
            msf_tasks = cmd_dict["tasks"]["metasploit"]["config"]
            for m in msf_tasks:
                print("Executing file ",m)
                parse_metasploit(m)
            

def proceed_questionmark():
        proceed = input("Do you want to proceed to the next workflow?(y/n)")

        if proceed != 'y':
            print('exiting...')
            exit()
        else:
            print('resuming workflow...')
        
#######################DEPRECATED################################
def append_task(table,task):
    print(f"Task discovered: {task}")
    table.append(task)

    return table

def check_for_tasks(cmd_dict):
    print("Discovering tasks...")

    discovered_tasks = []
    
    for task in cmd_dict["tasks"]:
        
        if "nmap" in task:
            #discovered_tasks = append_task(discovered_tasks,task)
            pass
            
        if "metasploit" in task:
            pass
            #discovered_tasks = append_task(discovered_tasks,task)
    
    #return discovered_tasks
def check_for_flags(cmd_dict):    
    pass
#######################DEPRECATED################################